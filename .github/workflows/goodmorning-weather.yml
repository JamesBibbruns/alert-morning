name: 早安 & 玉山降雨概率

on:
  schedule:
    - cron: '10 23 * * *'   # UTC 23:30 = 北京时间 07:30
  workflow_dispatch:        # 手动测试入口

jobs:
  push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - run: pip install requests

      - name: 获取天气 → 推群
        env:
          WECOM_WEBHOOK_KEY: ${{ secrets.WECOM_WEBHOOK_KEY }}
          CITY:              ${{ secrets.CITY }}
          AMAP_KEY:          ${{ secrets.AMAP_KEY }}  
        shell: python
        run: |
          import os, requests, datetime as dt
          from datetime import datetime

          # 1. 读取 Secret
          key  = os.getenv('WECOM_WEBHOOK_KEY')
          city = os.getenv('CITY')
          ak   = os.getenv('AMAP_KEY')
          url  = f'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key={key}'

          # 2. 高德天气（city=361123 对应江西上饶玉山）
          weather_url = (
              'https://restapi.amap.com/v3/weather/weatherInfo'
              '?city=361123&extensions=all&key=' + ak
          )
          r = requests.get(weather_url, timeout=10).json()
          if r['status'] != '1':
              raise RuntimeError('天气接口异常:' + str(r))

          today = r['forecasts'][0]['casts'][0]

          # 3. 降雨概率（白天/夜间分别判断）
          rain_codes = {'小雨','中雨','大雨','暴雨','雷阵雨'}
          day_prob   = 100 if today['dayweather']   in rain_codes else 0
          night_prob = 100 if today['nightweather'] in rain_codes else 0

          # 4. 温度
          day_temp   = today['daytemp']   # 白天温度区间，如 "28℃"
          night_temp = today['nighttemp'] # 夜间温度区间，如 "22℃"

          # 5. 拼装 Markdown
          date_str = datetime.today().strftime('%Y-%m-%d')
          md = f"""**☀️ 早安，新的一天！**  
`{date_str}` · {city}  
白天：{today['dayweather']} {day_temp}  | 降雨概率 {day_prob}%  
夜间：{today['nightweather']} {night_temp}  | 降雨概率 {night_prob}%  
祝各位今天顺利~"""

          payload = {"msgtype": "markdown", "markdown": {"content": md}}

          # 6. 推送到企业微信
          requests.post(url, json=payload, timeout=10).raise_for_status()
          print('✅ 早安推送完成')
