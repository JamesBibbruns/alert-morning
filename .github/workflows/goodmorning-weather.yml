name: 早安 & 玉山降雨概率

on:
  schedule:
    - cron: '30 23 * * *'   # UTC 23:30 = 北京时间 07:30

jobs:
  push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - run: pip install requests

      - name: 获取天气 → 推群
        env:
          WECOM_WEBHOOK_KEY: ${{ secrets.WECOM_WEBHOOK_KEY }}
          CITY:              ${{ secrets.CITY }}
          AMAP_KEY:          ${{ secrets.AMAP_KEY }}
        shell: python
        run: |
          import os, requests, datetime as dt
          from datetime import datetime

          # 1. 读取 Secret
          key  = os.getenv('WECOM_WEBHOOK_KEY')
          city = os.getenv('CITY')
          ak   = os.getenv('AMAP_KEY')
          url  = f'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key={key}'

          # 2. 高德天气（city=361123 对应江西上饶玉山）
          weather_url = (
              'https://restapi.amap.com/v3/weather/weatherInfo'
              '?city=361123&extensions=all&key=' + ak
          )
          r = requests.get(weather_url, timeout=10).json()
          if r['status'] != '1':
              raise RuntimeError('天气接口异常:' + str(r))

          today = r['forecasts'][0]['casts'][0]

          # 3. 降雨程度直接沿用天气文字，不再额外判断
          day_w    = today['dayweather']
          night_w  = today['nightweather']
          day_t    = today['daytemp']
          night_t  = today['nighttemp']

          # 4. 拼装 Markdown
          date_str = datetime.today().strftime('%Y-%m-%d')
          md = f"""**☀️ 早安，新的一天！**  
`{date_str}` · {city}  
白天：{day_w} {day_t}  
夜间：{night_w} {night_t}  
祝各位今天顺利~"""

          payload = {"msgtype": "markdown", "markdown": {"content": md}}

          # 5. 推送到企业微信
          requests.post(url, json=payload, timeout=10).raise_for_status()
          print('✅ 早安推送完成')
