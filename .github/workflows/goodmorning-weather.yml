name: 早安 & 玉山降雨概率（高德版·固定坐标）

on:
  schedule:
    - cron: '10 23 * * *'   # UTC 23:10 = 北京 07:10
  workflow_dispatch:

jobs:
  push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - run: pip install requests

      - name: 获取天气 → 推群
        env:
          WECOM_WEBHOOK_KEY: ${{ secrets.WECOM_WEBHOOK_KEY }}
          CITY:              ${{ secrets.CITY }}      # 仅用于文案展示
          GAODE_KEY:         ${{ secrets.GAODE_KEY }} # 必填：高德 Web 服务 Key
        shell: python
        run: |
          import os, requests, datetime, time, random

          key  = os.getenv('WECOM_WEBHOOK_KEY')
          city = os.getenv('CITY') or '玉山县'
          ak   = os.getenv('GAODE_KEY')
          if not ak:
              raise RuntimeError('请在仓库 Secrets 里配置 GAODE_KEY')

          wx_url = f'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key={key}'
          sess = requests.Session()
          sess.headers.update({'User-Agent': 'github-actions/1.0'})

          # ---------- 1. 玉山县 GCJ-02 坐标 ----------
          lon, lat = 118.2587, 28.6832

          # ---------- 2. 高德实时 + 逐小时 ----------
          # 实时
          realtime_url = (
              'https://restapi.amap.com/v3/weather/weatherInfo'
              f'?key={ak}&city=361123&extensions=base'
          )
          # 逐小时（含 24h）
          hourly_url = (
              'https://restapi.amap.com/v3/weather/weatherInfo'
              f'?key={ak}&city=361123&extensions=all'
          )

          def get_json(url):
              for attempt in range(1, 6):
                  try:
                      r = sess.get(url, timeout=30).json()
                      if r.get('status') != '1':
                          raise RuntimeError(r)
                      return r
                  except Exception as e:
                      print(f'[高德 attempt {attempt}] {e}')
                      if attempt == 5:
                          md = f"""**⚠️ 早安推送降级提醒**  
                          `{datetime.date.today()}` · {city}  
                          天气接口异常，请手动查看天气~"""
                          sess.post(wx_url, json={"msgtype": "markdown", "markdown": {"content": md}})
                          exit(0)
                      time.sleep(random.uniform(2, 5))

          realtime_resp = get_json(realtime_url)
          hourly_resp   = get_json(hourly_url)

          # ---------- 3. 解析 ----------
          now = realtime_resp['lives'][0]
          skycon = now['weather']               # 晴 / 多云 / 小雨 …
          temp   = int(float(now['temperature_float']))
          # 降水概率：逐小时里前 2 条 probability 取平均
          hourly = hourly_resp['forecasts'][0]['casts'][:2]
          pop = round(
              sum(int(h.get('probability', 0)) for h in hourly) / 2
          )

          # ---------- 4. 推送 ----------
          md = f"""**☀️ 早安，新的一天！**  
          `{datetime.date.today()}` · {city}  
          当前天气：{skycon}  
          当前温度：{temp}°C  
          **未来 2h 降水概率 ≈ {pop} %**  
          祝各位今天顺利~"""

          r = sess.post(wx_url, json={"msgtype": "markdown", "markdown": {"content": md}})
          print('✅ 早安推送完成' if r.status_code == 200 else '❌ 推送失败')
