name: 早安 & 玉山降雨概率（彩云公益版）

on:
  schedule:
    - cron: '10 23 * * *'   # UTC 23:10 = 北京时间 07:10
  workflow_dispatch:

jobs:
  push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 获取天气 → 推群
        env:
          WECOM_WEBHOOK_KEY: ${{ secrets.WECOM_WEBHOOK_KEY }}
          CITY:              ${{ secrets.CITY }}          # 举例：玉山县
        shell: python
        run: |
          import os, requests, datetime, time, random

          # ---------- 0. 参数 ----------
          key  = os.getenv('WECOM_WEBHOOK_KEY')
          city = os.getenv('CITY') or '玉山县'
          wx_url = f'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key={key}'

          # 彩云公益版 token（官方公开，可公用）
          cy_token = 'TAkhjf8d1nlSlspN'

          sess = requests.Session()
          sess.headers.update({'User-Agent': 'github-actions/1.0'})

          # ---------- 1. 城市名 → 经纬度（高德地理编码，免费 1 万次/天） ----------
          geo_url = 'https://restapi.amap.com/v3/geocode/geo'
          gaode_key = 'a7c88b112233445566778899aabbccd0'   # 可换成自己的
          try:
              r = sess.get(geo_url, params={'key': gaode_key, 'address': city, 'output': 'json'}, timeout=10).json()
              loc = r['geocodes'][0]['location']          # "118.23,34.56"
              lon, lat = loc.split(',')
          except Exception as e:
              raise RuntimeError(f'城市解析失败 → {e}')

          # ---------- 2. 彩云实时 + 分钟级预报 ----------
          # 接口文档：https://open.caiyunapp.com/#minute
          # 返回：skycon（天气现象）、temperature（℃）、precipitation（mm/h）、probability（0~1）
          cy_url = f'https://api.caiyunapp.com/v2.5/{cy_token}/{lon},{lat}/realtime.json'
          for attempt in range(1, 6):
              try:
                  resp = sess.get(cy_url, timeout=30).json()
                  if resp.get('status') != 'ok':
                      raise RuntimeError(f'业务错误 → {resp}')
                  break
              except Exception as e:
                  print(f'[彩云 attempt {attempt}] {e}')
                  if attempt == 5:
                      md = f"""**⚠️ 早安推送降级提醒**  
                      `{datetime.date.today()}` · {city}  
                      天气接口异常，请手动查看天气~"""
                      sess.post(wx_url, json={"msgtype": "markdown", "markdown": {"content": md}})
                      exit(0)
                  time.sleep(random.uniform(2, 5))

          # ---------- 3. 解析 ----------
          result = resp['result']
          realtime = result['realtime']

          # 天气现象
          skycon_map = {
              'CLEAR_DAY': '晴', 'CLEAR_NIGHT': '晴',
              'PARTLY_CLOUDY_DAY': '多云', 'PARTLY_CLOUDY_NIGHT': '多云',
              'CLOUDY': '阴', 'LIGHT_HAZE': '轻度霾', 'MODERATE_HAZE': '中度霾',
              'HEAVY_HAZE': '重度霾', 'LIGHT_RAIN': '小雨', 'MODERATE_RAIN': '中雨',
              'HEAVY_RAIN': '大雨', 'STORM_RAIN': '暴雨', 'FOG': '雾',
              'LIGHT_SNOW': '小雪', 'MODERATE_SNOW': '中雪', 'HEAVY_SNOW': '大雪',
              'STORM_SNOW': '暴雪', 'HAIL': '冰雹', 'SLEET': '雨夹雪'
          }
          skycon = skycon_map.get(realtime['skycon'], realtime['skycon'])

          # 温度
          temp = round(realtime['temperature'])

          # 降水概率（分钟级接口给出 0~1）
          pop = round(realtime.get('probability', [0])[0] * 100)

          # ---------- 4. 推送 ----------
          md = f"""**☀️ 早安，新的一天！**  
          `{datetime.date.today()}` · {city}  
          当前天气：{skycon}  
          当前温度：{temp}°C  
          **未来 2h 降水概率 ≈ {pop} %**  
          祝各位今天顺利~"""

          sess.post(wx_url, json={"msgtype": "markdown", "markdown": {"content": md}})
          print('✅ 早安推送完成')
