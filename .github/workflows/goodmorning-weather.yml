name: 早安 & 玉山降雨概率

on:
  schedule:
    # UTC 23:30 = 北京时间 07:30
    - cron: '10 23 * * *'
  workflow_dispatch:        # 手动触发按钮

jobs:
  push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - run: pip install requests urllib3

      - name: 获取天气 → 推群
        env:
          WECOM_WEBHOOK_KEY: ${{ secrets.WECOM_WEBHOOK_KEY }}
          CITY:              ${{ secrets.CITY }}
          AMAP_KEY:          ${{ secrets.AMAP_KEY }}
        shell: python
        run: |
          import os, requests, datetime, time, random

          # ---------- 1. 参数 ----------
          key  = os.getenv('WECOM_WEBHOOK_KEY')
          city = os.getenv('CITY') or '361123'          # 玉山县
          ak   = os.getenv('AMAP_KEY')
          wx_url = f'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key={key}'
          weather_url = (
              'https://restapi.amap.com/v3/weather/weatherInfo'
              f'?city={city}&extensions=all&key={ak}'
          )

          # ---------- 2. 带重试的请求 ----------
          sess = requests.Session()
          sess.headers.update({'User-Agent': 'github-actions/1.0'})
          for attempt in range(1, 6):               # 最多 5 次
              try:
                  resp = sess.get(weather_url, timeout=30).json()
                  if resp.get('status') == '1':
                      break
                  raise RuntimeError(f'业务错误: {resp}')
              except Exception as e:
                  print(f'[attempt {attempt}] {e}')
                  if attempt == 5:
                      # 彻底失败，推送降级消息
                      md = f"""**⚠️ 早安推送降级提醒**  
                      `{datetime.date.today()}` · {city}  
                      天气接口超时，请手动查看天气~"""
                      payload = {"msgtype": "markdown", "markdown": {"content": md}}
                      sess.post(wx_url, json=payload, timeout=10)
                      exit(0)
                  time.sleep(random.uniform(2, 5))

          # ---------- 3. 解析 ----------
          today = resp['forecasts'][0]['casts'][0]
          rain_map = {"小雨": "轻微降雨", "中雨": "中等降雨", "大雨": "较强降雨",
                      "暴雨": "暴雨", "雷阵雨": "雷阵雨", "阵雨": "阵雨"}

          def desc(weather):
              return rain_map.get(weather, "无降雨")

          day_w   = today['dayweather']
          night_w = today['nightweather']
          md = f"""**☀️ 早安，新的一天！**  
          `{datetime.date.today()}` · {city}  
          白天：{day_w} | 夜间：{night_w}  
          白天温度：{today['daytemp']}°C | 夜间温度：{today['nighttemp']}°C  
          **白天降雨概率 ≈ {100 if day_w in rain_map else 0} %** - {desc(day_w)}  
          **夜间降雨概率 ≈ {100 if night_w in rain_map else 0} %** - {desc(night_w)}  
          祝各位今天顺利~"""

          # ---------- 4. 推送 ----------
          payload = {"msgtype": "markdown", "markdown": {"content": md}}
          sess.post(wx_url, json=payload, timeout=10)
          print('✅ 早安推送完成')
