name: 每日考勤&早安推送

on:
  schedule:
    - cron: '30 0 * * 1-6'   # 周一到周六 08:30 BJ
  workflow_dispatch:         # 手动兜底

jobs:
  push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: 安装依赖
        run: pip install requests  # 纯 API 调用，无需 playwright

      - name: 获取考勤 → 推送
        env:
          WECOM_WEBHOOK_KEY: ${{ secrets.WECOM_WEBHOOK_KEY }}
          ATTENDANCE_URL:    ${{ secrets.ATTENDANCE_URL }}
          ATTENDANCE_TOKEN:  ${{ secrets.ATTENDANCE_TOKEN }}
        shell: python
        run: |
          import os, json, requests, datetime as dt
          from datetime import datetime

          # 1. 读 Secret
          key      = os.getenv('WECOM_WEBHOOK_KEY')
          api      = os.getenv('ATTENDANCE_URL')
          token    = os.getenv('ATTENDANCE_TOKEN')
          webhook  = f"https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key={key}"

          # 2. 调考勤接口（示例为 GET，可按实际改 POST+body）
          try:
              r = requests.get(api, headers={'Authorization': token}, timeout=10)
              r.raise_for_status()
              data = r.json()
          except Exception as e:
              # 接口失败也继续，给个人工提示
              data = {'should': 0, 'actual': 0, 'late': 0, 'absent': 0}

          # 3. 组装 Markdown
          today = datetime.today().strftime('%Y-%m-%d')
          should  = data.get('should', 0)
          actual  = data.get('actual', 0)
          late    = data.get('late', 0)
          absent  = data.get('absent', 0)

          md = f"""**☀️ 早安，新的一天！**  
`{today}` 考勤概览  
应到 **{should}** 人 | 实到 **{actual}** 人  
迟到 **{late}** 人 | 缺卡 **{absent}** 人  
祝大家今日份顺利~"""
          payload = {"msgtype": "markdown", "markdown": {"content": md}}

          # 4. 推到企业微信
          requests.post(webhook, json=payload, timeout=10).raise_for_status()
          print('✅ 推送完成')
